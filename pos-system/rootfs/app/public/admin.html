<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - POS System</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px 30px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .navbar h1 { font-size: 20px; }
        .navbar-actions button { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 8px; }
        .stat-card .value { font-size: 28px; font-weight: bold; color: #333; }
        .card { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { font-size: 18px; color: #333; }
        .card-body { padding: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #666; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { font-size: 20px; }
        .close { font-size: 28px; cursor: pointer; color: #666; }
        #scanner-container { width: 100%; max-width: 400px; margin: 0 auto; background: #000; position: relative; }
        #scanner-container video { width: 100%; }
        .scanner-line { position: absolute; top: 50%; left: 5%; width: 90%; height: 2px; background: red; animation: scan 2s infinite; }
        @keyframes scan { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .barcode-input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .barcode-input-group input { flex: 1; }
        .alert { padding: 12px; border-radius: 5px; margin-bottom: 15px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>üè™ POS Admin</h1>
        <div style="display: flex; gap: 20px;">
            <a href="#" onclick="switchView('products')" style="color: white; text-decoration: none; font-weight: bold;">üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>
            <a href="#" onclick="switchView('users')" style="color: white; text-decoration: none; font-weight: bold;">üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
        </div>
        <div class="navbar-actions">
            <span id="userName"></span>
            <button onclick="window.location.href='cashier.html'">üíµ ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢</button>
            <button onclick="logout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </nav>

    <div class="container">
        <div class="stats-row" id="statsRow"></div>

        <!-- Products View -->
        <div id="products-view">
            <div class="card">
                <div class="card-header">
                    <h2>üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                    <button class="btn btn-primary" onclick="openAddModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                </div>
                <!-- ... existing product table ... -->
            <div class="card-body">
                <div class="barcode-input-group">
                    <input type="text" id="searchBarcode" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î...">
                    <button class="btn btn-warning" onclick="startScanner('search')">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô</button>
                    <button class="btn btn-success" onclick="searchProduct()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="productsTable">
                        <thead>
                            <tr>
                                <th>‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th>
                                <th>‡∏Å‡∏≥‡πÑ‡∏£ %</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                                <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        </div> <!-- End products-view -->

        <!-- Users View -->
        <div id="users-view" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
                    <button class="btn btn-primary" onclick="openUserModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                </div>
                <div class="card-body">
                    <div style="overflow-x: auto;">
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</th>
                                    <th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- End Container -->

    <!-- Add/Edit User Modal -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                <span class="close" onclick="closeUserModal()">&times;</span>
            </div>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="userUsername" required>
                </div>
                <div class="form-group">
                    <label>Password (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</label>
                    <input type="password" id="userPassword">
                </div>
                <div class="form-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</label>
                    <input type="text" id="userDisplayName" required>
                </div>
                <div class="form-group">
                    <label>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                    <select id="userRole" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="cashier">Cashier</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <select id="userStatus" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="1">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                        <option value="0">‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalAlert"></div>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label>‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="barcode" required style="flex: 1;">
                        <button type="button" class="btn btn-warning" onclick="startScanner('form')">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="costPrice" step="0.01" required onchange="calculatePrice()">
                    </div>
                    <div class="form-group">
                        <label>‡∏Å‡∏≥‡πÑ‡∏£ (%)</label>
                        <input type="number" id="profitMargin" step="0.01" value="30" required onchange="calculatePrice()">
                    </div>
                    <div class="form-group">
                        <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="price" step="0.01" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</label>
                    <input type="number" id="stock" value="0" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </form>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div class="modal" id="scannerModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</h3>
                <span class="close" onclick="stopScanner()">&times;</span>
            </div>
            <div id="scanner-container">
                <div class="scanner-line"></div>
            </div>
            <div style="margin-top: 15px;">
                <input type="text" id="manualBarcode" placeholder="‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á..." style="width: 100%; padding: 10px;">
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="useManualBarcode()">‡πÉ‡∏ä‡πâ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.pathname.replace(/\/[^\/]*$/, '') + '/api';
        const token = localStorage.getItem('pos_token');
        let scannerTarget = 'form';
        let products = [];

        if (!token) window.location.href = 'index.html';

        const user = JSON.parse(localStorage.getItem('pos_user') || '{}');
        document.getElementById('userName').textContent = `üë§ ${user.display_name || user.username}`;

        async function fetchAPI(endpoint, options = {}) {
            const response = await fetch(`${API_URL}${endpoint}`, {
                ...options,
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers }
            });
            return response.json();
        }

        async function loadDashboard() {
            const result = await fetchAPI('/dashboard');
            if (result.status === 'success') {
                const d = result.data;
                document.getElementById('statsRow').innerHTML = `
                    <div class="stat-card"><h3>üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><div class="value">${d.total_products}</div></div>
                    <div class="stat-card"><h3>‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</h3><div class="value" style="color:#dc3545">${d.low_stock_count}</div></div>
                    <div class="stat-card"><h3>üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3><div class="value" style="color:#28a745">‡∏ø${parseFloat(d.todays_sales || 0).toLocaleString()}</div></div>
                    <div class="stat-card"><h3>üßæ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3><div class="value">${d.todays_transactions}</div></div>
                `;
            }
        }

        async function loadProducts() {
            const result = await fetchAPI('/products');
            if (result.status === 'success') {
                products = result.data;
                renderProducts(products);
            }
        }

        function renderProducts(list) {
            const tbody = document.querySelector('#productsTable tbody');
            tbody.innerHTML = list.map(p => `
                <tr>
                    <td>${p.barcode || '-'}</td>
                    <td>${p.name}</td>
                    <td>‡∏ø${parseFloat(p.cost_price || 0).toFixed(2)}</td>
                    <td>${parseFloat(p.profit_margin || 0).toFixed(1)}%</td>
                    <td>‡∏ø${parseFloat(p.price).toFixed(2)}</td>
                    <td style="color: ${p.quantity < 10 ? 'red' : 'green'}">${p.quantity}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editProduct(${p.id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function calculatePrice() {
            const cost = parseFloat(document.getElementById('costPrice').value) || 0;
            const margin = parseFloat(document.getElementById('profitMargin').value) || 0;
            const price = cost * (1 + margin / 100);
            document.getElementById('price').value = price.toFixed(2);
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('profitMargin').value = '30';
            document.getElementById('modalAlert').innerHTML = '';
            document.getElementById('productModal').style.display = 'flex';
        }

        function editProduct(id) {
            const p = products.find(x => x.id === id);
            if (!p) return;
            document.getElementById('modalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
            document.getElementById('productId').value = p.id;
            document.getElementById('barcode').value = p.barcode || '';
            document.getElementById('name').value = p.name;
            document.getElementById('costPrice').value = p.cost_price || 0;
            document.getElementById('profitMargin').value = p.profit_margin || 0;
            document.getElementById('price').value = p.price;
            document.getElementById('stock').value = p.quantity;
            document.getElementById('modalAlert').innerHTML = '';
            document.getElementById('productModal').style.display = 'flex';
        }

        async function deleteProduct(id) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?')) return;
            const result = await fetchAPI(`/products/${id}`, { method: 'DELETE' });
            if (result.status === 'success') {
                loadProducts();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const data = {
                barcode: document.getElementById('barcode').value,
                name: document.getElementById('name').value,
                cost_price: parseFloat(document.getElementById('costPrice').value),
                profit_margin: parseFloat(document.getElementById('profitMargin').value),
                price: parseFloat(document.getElementById('price').value),
                quantity: parseInt(document.getElementById('stock').value)
            };
            
            const result = await fetchAPI(id ? `/products/${id}` : '/products', {
                method: id ? 'PUT' : 'POST',
                body: JSON.stringify(data)
            });

            const alertDiv = document.getElementById('modalAlert');
            if (result.status === 'success') {
                alertDiv.innerHTML = '<div class="alert alert-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>';
                setTimeout(() => { closeModal(); loadProducts(); loadDashboard(); }, 1000);
            } else {
                alertDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
            }
        });

        function searchProduct() {
            const term = document.getElementById('searchBarcode').value.trim().toLowerCase();
            if (!term) { renderProducts(products); return; }
            const filtered = products.filter(p => 
                (p.barcode && String(p.barcode).toLowerCase().includes(term)) || 
                (p.name && p.name.toLowerCase().includes(term))
            );
            renderProducts(filtered);
        }

        document.getElementById('searchBarcode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchProduct();
        });

        let html5QrCode;

        function startScanner(target) {
            scannerTarget = target;
            document.getElementById('scannerModal').style.display = 'flex';
            document.getElementById('manualBarcode').value = '';
            
            // Remove scanner line if present, let Html5Qrcode handle or use simple center
            // actually we can keep the custom overlay but ensure it is visible
            
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("scanner-container");
            }

            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0 
            };
            
            html5QrCode.start(
                { facingMode: "environment" }, 
                config, 
                (decodedText, decodedResult) => {
                    stopScanner();
                    handleScannedBarcode(decodedText);
                },
                (errorMessage) => {
                    // parse error, ignore
                }
            ).catch(err => {
                console.error("Error starting scanner", err);
                alert("Error starting camera: " + err);
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scannerModal').style.display = 'none';
                }).catch(err => {
                    console.log("Error stopping scanner", err);
                    document.getElementById('scannerModal').style.display = 'none';
                });
            } else {
                document.getElementById('scannerModal').style.display = 'none';
            }
        }

        function useManualBarcode() {
            const code = document.getElementById('manualBarcode').value.trim();
            if (code) { stopScanner(); handleScannedBarcode(code); }
        }

        function handleScannedBarcode(code) {
            if (scannerTarget === 'form') {
                document.getElementById('barcode').value = code;
            } else {
                document.getElementById('searchBarcode').value = code;
                searchProduct();
            }
        }

        function logout() {
            localStorage.removeItem('pos_token');
            localStorage.removeItem('pos_user');
            window.location.href = 'index.html';
        }

        // ================== USER MANAGEMENT ==================
        function switchView(view) {
            if (view === 'products') {
                 document.getElementById('products-view').style.display = 'block';
                 document.getElementById('users-view').style.display = 'none';
                 loadProducts();
            } else {
                 document.getElementById('products-view').style.display = 'none';
                 document.getElementById('users-view').style.display = 'block';
                 loadUsers();
            }
        }

        let users = [];
        async function loadUsers() {
            const result = await fetchAPI('/users');
            if (result.status === 'success') {
                users = result.data;
                renderUsers(users);
            }
        }

        function renderUsers(list) {
            const currentUser = JSON.parse(localStorage.getItem('pos_user'));
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = list.map(u => `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.display_name}</td>
                    <td>${u.role}</td>
                    <td>
                        <span style="color: ${u.is_active ? 'green' : 'red'}">
                            ${u.is_active ? '‚úÖ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‚ùå ‡∏£‡∏∞‡∏á‡∏±‡∏ö'}
                        </span>
                    </td>
                    <td>${new Date(u.created_at).toLocaleDateString('th-TH')}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editUser(${u.id})">‚úèÔ∏è</button>
                        ${u.id !== currentUser.id ? 
                        `<button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">üóëÔ∏è</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function openUserModal() {
            document.getElementById('userModalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userUsername').disabled = false;
            document.getElementById('userStatus').value = '1';
            document.getElementById('userModal').style.display = 'flex';
        }

        function editUser(id) {
            const u = users.find(x => x.id === id);
            if (!u) return;
            document.getElementById('userModalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            document.getElementById('userId').value = u.id;
            document.getElementById('userUsername').value = u.username;
            document.getElementById('userUsername').disabled = true;
            document.getElementById('userDisplayName').value = u.display_name;
            document.getElementById('userRole').value = u.role;
            document.getElementById('userStatus').value = u.is_active ? '1' : '0';
            document.getElementById('userPassword').value = '';
            document.getElementById('userModal').style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        async function deleteUser(id) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£?')) return;
            const result = await fetchAPI(`/users/${id}`, { method: 'DELETE' });
             if (result.status === 'success') {
                loadUsers();
            } else {
                alert(result.message);
            }
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('userId').value;
            const data = {
                username: document.getElementById('userUsername').value,
                password: document.getElementById('userPassword').value,
                display_name: document.getElementById('userDisplayName').value,
                role: document.getElementById('userRole').value,
                is_active: document.getElementById('userStatus').value === '1'
            };

            if (id && !data.password) delete data.password;

            const url = id ? `/users/${id}` : '/users';
            const method = id ? 'PUT' : 'POST';

            const result = await fetchAPI(url, { method, body: JSON.stringify(data) });
            if (result.status === 'success') {
                closeUserModal();
                loadUsers();
            } else {
                alert(result.message);
            }
        });

        loadDashboard();
        loadProducts();
    </script>
</body>
</html>
